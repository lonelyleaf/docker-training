# 当前架构与一些工具的简介

这里介绍一下围业务服务部署的环境（主要是rancher）的部分架构，主要是从http 请求到服务响应的整个过程。

然后还介绍一些当前运维用到的一些工具，也许可以开拓大家的眼界。部分工具也是完全可以用到开发中，或者
去支撑一些业务服务。

## 架构的简单说明

### http请求现在是怎么到达服务的？

比如一个`GET http://tms.mygmt.cn`的请求经过了那些处理？

1. 在请求过了防火墙、和nginx前的lvs4层负载均衡后，请求到达了nginx集群。nginx现在一律将
规则为`*.mygmt.cn`的域名交给后面rancher中的traefik集群。

2. traefik会不断监听rancher服务中的服务原信息，根据docker label中的traefik配置，来动态事实的生成
路由信息。这里当`GET http://tms.mygmt.cn`到达后，就会找到规则为`traefik.frontend.rule=Host:tms.haorun.win`
的服务，将请求交给它。

3. 服务处理完请求后，将响应原路返回

![新架构说明](imgs/新架构说明.jpg)


### 为什么搞这么复杂，要两级7层负载

首先除了业务服务外，还有很多服务现在是没办法容器化的，是单独部署到虚拟机上的。另外nginx虽然配置
比较复杂，但功能要比traefik多很多（但性能两者差距不大，nginx基本只比traefik快30%左右）。

而使用traefik来做业务的负载与路由，主要是考虑服务变多后，如果全部都用nginx来做，nginx的配置会
非常复杂。实际上，在迁移服务前，所有服务都在单个主机的时候，nginx的配置就已经复杂，而且配置中
只有端口号可以和服务对应，很难维护和对应服务的时间情况。

而traefik的配置是直接和服务写在一起，在其对应容器的docker label中，配置简单明了，甚至在开发人员
简单学习后可以自己配置路由信息。并且由于其是根据服务的真实情况来动态生成路由，在服务宕机时相当
于有了简单的熔断保护。


### 容器中数据的持久化

现在有3个rancher集群，分别是：
- 基础设施 inf ，用于部署支持开发和公司的一些基础服务（git、nexus等）
- 测试环境 test，业务的测试环境
- 生产环境 prod，业务的生产环境

三个环境都有服务需要写入，并持久化文件的需求。每个环境都是通过nfs来挂载远程磁盘目录来实现的。




## 运维周边的服务与工具



spring-cloud-config-server + git 用作服务的配置中心

gitea git服务

nexue 用作maven、docker仓库，还支持多种服务

jenkins ci系统

minio 一个对象存储，兼容aws s3的api，并且有多端的sdk

seafile 网盘

ansible 主机配置管理



日志收集 elasticsearch -> filebeats或logstash -> kibana
监控 prometheus -> grafana
promethus对各种系统、软件的监控 https://prometheus.io/docs/instrumenting/exporters/

## 还缺什么？

自定义的dns，